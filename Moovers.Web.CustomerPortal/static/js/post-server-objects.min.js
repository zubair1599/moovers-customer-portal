(function(){var n,i,u,t,r;n=function(){function n(n){$.extend(this,n)}return n.prototype.getDisplayValue=function(){return""+this.NameFirst+" "+this.NameLast+" ("+this.Lookup+")"},n.prototype.displayName=function(){return""+this.NameFirst+"  "+this.NameLast},n}(),window.Employee=n,t=function(){function n(n){$.extend(this,n)}return n.prototype.getDisplayValue=function(){return""+this.Name+" ("+this.Lookup+")"},n}(),window.Vehicle=t,r=function(){function n(n,i){this.Vehicle=n instanceof t?n:new t(n.Vehicle),this.Posting=i,this.VehicleID=n.VehicleID,this.IsRemoved=n.IsRemoved||!1}return n}(),i=function(){function t(t,i){var r,u,f,e,o,s;this.Employee=t instanceof n?t:new n(t.Employee),this.Posting=i,this.EmployeeID=t.EmployeeID,this.Wage=(u=t.Wage)!=null?u:0,this.Tip=(f=t.Tip)!=null?f:0,this.Bonus=(e=t.Bonus)!=null?e:0,this.Commission=(o=t.Commission)!=null?o:0,this.Hours=(s=t.Hours)!=null?s:0,this.IsRemoved=t.IsRemoved||!1,this.ForceNoDriver=t.ForceNoDriver||!1,r=_.chain((this.Posting||{}).Crew_Drivers).map(function(n){return n.EmployeeID}).contains(t.EmployeeID).value(),this.IsDriver=t.IsDriver||r&&!this.ForceNoDriver||!1}return t.prototype.getCommissionPercent=function(){var n,t;return(t=this.Posting.calculateMovingCost(),n=this.Commission,t===0||n===0)?0:Utility.roundCurrency(n/t*100)},t.prototype.getTotal=function(){return Utility.roundCurrency(this.Commission+this.Bonus+this.Tip)},t.prototype.getManHourRate=function(){var t,n;return this.Posting.IsHourly?0:(t=this.Posting.GuaranteedPricing.GuaranteedPrice,n=this.Posting.calculateManHours(),!n)?0:t/n},t.prototype.getCommission=function(){var i,n,t;return t=this.Posting.calculateMovingCost(),n=this.Posting.calculateManHours(),i=t>500?.25:.2,n===0?0:t*i/n*this.Hours},t}(),u=function(){function u(f,e){var s,o,h;o=this,$.extend(o,f),this.Date=new Date(f.Date),this.autoCalc=!0,this.hasChanged=!1,this.delayedHasChanged=!1,this.container=e,this.IsCurrent=!_.isUndefined(e),this.StorageAccount=JSON.parse(f.StorageAccount),this.Crew_Drivers=_(f.Crew_Employee_Rels).filter(function(n){return n.IsDriver}).map(function(t){return new n(t.Employee)}),this.Employee_Rels=_.map(f.Employee_Rels,function(n){return new i(n,o)}),this.Vehicle_Rels=_.map(f.Vehicle_Rels,function(n){return new r(n,o)}),this.Crew_Employees=_.map(f.Crew_Employee_Rels,function(t){return new n(t.Employee)}),this.Crew_Vehicles=_.map(f.Crew_Vehicle_Rels,function(n){return new t(n)}),s=_.pluck(o.Employee_Rels,"EmployeeID"),_.each(o.Crew_Employees,function(n){if(!_.contains(s,n.EmployeeID))return o.addEmployee(n,!1)}),h=_.pluck(o.Vehicle_Rels,"VehicleID"),_.each(o.Crew_Vehicles,function(n){if(!_.contains(h,n.VehicleID))return o.addVehicle(n,!1)}),_.each(o.OtherServices,function(n){return n.Posting=o}),this.Siblings=_.map(f.Siblings,function(n){return new u(n)})}return u.prototype.retemplate=function(){var t,i,n,r,u;return r=window.scrollY,u=PostingTemplates.templates.posting,i=u(this),this.container.find("[autocomplete]").each(function(){if($(this).data("autocomplete"))return $(this).autocomplete("destroy")}),n=this.container.empty().append(i),t=this.container,setTimeout(function(){n.find("input").trigger("change");return PostingTemplates.onTemplate(t)},10),this.updateCalculatedFields(),window.scroll(window.scrollX,r),n},u.prototype.retemplateEmployees=function(){var n,t;return n=this.container.find(".employee-job-post tbody"),t=this.RenderEmployees(),n.html(t)},u.prototype.setEmployeeField=function(n,t,i){var r;if(!this.IsComplete)return this.hasChanged=!0,r=_.find(this.Employee_Rels,function(t){return t.EmployeeID===n}),r[t]=i,this.updateCalculatedFields()},u.prototype.setCustomField=function(n,t){var i;if(!this.IsComplete)return this.hasChanged=!0,i=_.find(this.OtherServices,function(t){return t.ServiceID===n}),i&&(i.Price=t),this.updateCalculatedFields()},u.prototype.setField=function(n,t){var i,o,f,r,u,s,e;if(!this.IsComplete){for(o=function(n){return Object.prototype.toString.call(n)==="[object Object]"},this.hasChanged=!0,i=this,r=n.split(/\./g),e=r.slice(0,r.length-1),u=0,s=e.length;u<s;u++)if(f=e[u],i=i[f],!o(i))throw"Set Prop: Error : Cannot set "+f;return i[r[r.length-1]]=t,this.updateCalculatedFields()}},u.prototype.getTdClass=function(){return this.isEditable()?"input-td":this.IsRemoved?"disabled":""},u.prototype.isEditable=function(){return!this.IsComplete&&this.IsCurrent},u.prototype.updateCalculatedFields=function(){var t,n,r,u,f,i,e,o;return f=this.container.find("span.hour-display"),i=this.container.find("span.moving-services-price"),o=this.container.find("span.total-display"),n=this.container.find("span.balance-display"),r=this.container.find("span[name=totalMovePrice]"),f.text(Utility.formatCurrency(this.calculateMovingHours(),"","")),o.text(Utility.formatCurrency(this.calculateTotalCost())),e=this,_.each(this.Employee_Rels,function(n){var t;return t=e.container.find("tr[data-employeeid="+n.EmployeeID+"]"),t.find("[name=Commission_Percent]").val(n.getCommissionPercent()),t.find(".Commission_Percent").text(n.getCommissionPercent()),t.find(".total-pay").text(Utility.formatCurrency(n.getTotal())),t.find(".man-hour-rate").text(Utility.formatCurrency(n.getManHourRate(),""))}),this.IsHourly?(i.text(Utility.formatCurrency(this.calculateMovingCost())),t=this.calculateBalance(),n.text(Utility.formatCurrency(t)),n.toggleClass("red",t!==0)):(u=this.GuaranteedPricing.GuaranteedPrice,r.text(Utility.formatCurrency(this.calculateTotalCost())),i.text(Utility.formatCurrency(u)),n.text(Utility.formatCurrency(0)))},u.prototype.RenderMovingServices=function(){var n,t,i;return i=PostingTemplates.templates.moving_service_rel,n=this,t=_.sortBy(_.flatten([n.Siblings,n]),function(t){return t.IsCurrent=t===n,""+t.Date+"\x00"+!t.IsCancelled}),_.map(t,function(n){return i(n)}).join("")},u.prototype.RenderCustomServices=function(){var n,t,i;return t=this.OtherServices,i=PostingTemplates.templates.posting_service,n=0,_.map(t,function(t){return t.idx=n,n++,i(t)}).join("")},u.prototype.RenderEmployees=function(n){var t,i;return i=PostingTemplates.templates.employee_rel,t=0,_.chain(this.Employee_Rels).sortBy(function(n){return parseInt(n.Employee.Lookup,10)||0}).map(function(r){return r.idx=t,r.hide=n||!1,t=t+10,i(r,{variable:"rel"})}).value().join("")},u.prototype.RenderVehicles=function(){var n;return n=PostingTemplates.templates.vehicle_rel,_.map(this.Vehicle_Rels,function(t){return n(t)}).join("")},u.prototype.calculateTotalCost=function(){var n;return n=this.PackingMaterialsCost+this.PackingServiceCost+this.StorageFeesCost+this.ValuationCost,n+=_.sum(this.OtherServices,function(n){return n.Price}),n+=this.calculateMovingCost(),Utility.roundCurrency(n)},u.prototype.calculateTip=function(){return _.sum(this.Employee_Rels,"Tip")},u.prototype.calculateCostWithTip=function(){return this.calculateTotalCost()+this.calculateTip()},u.prototype.calculateBalance=function(){var n,t;return t=this.FinalPostedPrice,n=this.calculateTotalCost(),Utility.roundCurrency(t-n)},u.prototype.calculateManHours=function(){var n,t;return n=_(this.Employee_Rels).filter(function(n){return!n.IsRemoved}),t=_.chain(this.Siblings).pluck("Employee_Rels").flatten().filter(function(n){return!n.IsRemoved}).value(),_.chain(n.concat(t)).pluck("Hours").sum().value()},u.prototype.calculateMovingHours=function(){return Utility.roundCurrency(_.sum(_.flatten([this,this.Siblings]),function(n){return n.PostingHours}))},u.prototype.getHourlyPricingDescription=function(){var r,u,n,t,i;return this.IsHourly?(t=_.chain([this,this.Siblings]).flatten(),u=t.sum(function(n){return n.HourlyPricing.FirstHourPrice-n.HourlyRate}).value(),n={},r=function(t,i){return n[i]=n[i]||0,n[i]+=t},t.each(function(n){return r(n.PostingHours,n.HourlyRate)}),i=Utility.formatCurrency(u,"$","",0)+" travel fee",_.each(n,function(n,t){return i+="\n "+n+" hours @"+Utility.formatCurrency(t)+" = "+Utility.formatCurrency(n*t)}),i):""},u.prototype.calculateMovingCost=function(){var n;return this.IsHourly?(n=_.flatten([this,this.Siblings]),_.sum(n,function(n){var t,i,r;return n.IsCancelled?0:(t=n.HourlyPricing.FirstHourPrice,i=n.HourlyRate,r=n.PostingHours,Utility.roundCurrency(t+(Math.max(r,1)-1)*i))})):this.GuaranteedPricing.GuaranteedPrice},u.prototype.addCustomService=function(n){var t;if(!this.IsComplete)return t={ServiceID:Utility.randomid(),PostingID:this.PostingID,Posting:this,Description:n,Type:4,Price:0},this.OtherServices.push(t),this.retemplate()},u.prototype.removeService=function(n){if(!this.IsComplete)return this.OtherServices=_.reject(this.OtherServices,function(t){return t.ServiceID===n}),this.retemplate(),this.updateCalculatedFields()},u.prototype.addEmployee=function(n,t){var u,r;if(!this.IsComplete)return t=t!=null?t:!0,r=_(this.Employee_Rels).filter(SearchFunctions.employee(n)),_.any(r)?r[0].IsRemoved=!1:(u=this,u.removeEmployee(n),r=new i(n,u),r.Wage=n.Wage,r.Hours=u.PostingHours+u.DriveHours,r.IsRemoved=!1,r.Bonus=0,r.Commission=0,r.Tip=0,u.Employee_Rels.push(r)),t?this.retemplate():void 0},u.prototype.addVehicle=function(n,t){var i;if(!this.IsComplete)return t=t!=null?t:!0,i=_(this.Vehicle_Rels).filter(SearchFunctions.vehicle(n)),_.any(i)?i[0].IsRemoved=!1:(this.removeVehicle(n),i=new r(n),i.Posting=this,this.Vehicle_Rels.push(i)),t?this.retemplate():void 0},u.prototype.removeEmployee=function(n){var r,i,t;if(!this.IsComplete&&n)return t=SearchFunctions.employee(n),r=_(this.Crew_Employees).filter(t),i=_(this.Employee_Rels).filter(t),_.any(r)&&_.any(i)?i[0].IsRemoved=!0:this.Employee_Rels=_.reject(this.Employee_Rels,t)},u.prototype.removeVehicle=function(n){var r,i,t;if(!this.IsComplete&&n)return t=SearchFunctions.vehicle(n),r=_(this.Crew_Vehicles).filter(t),i=_(this.Vehicle_Rels).filter(t),_.any(r)&&_.any(i)?i[0].IsRemoved=!0:this.Vehicle_Rels=_.reject(this.Vehicle_Rels,t)},u.prototype.toServerObject=function(){return{id:this.PostingID,finalPostedPrice:this.FinalPostedPrice,postingHours:this.PostingHours||0,driveHours:this.DriveHours||0,hourlyRate:this.HourlyRate,firstHourRate:this.IsHourly?this.HourlyPricing.FirstHourPrice:null,packingMaterialsCost:this.PackingMaterialsCost,packingServiceCost:this.PackingServiceCost,storageFeesCost:this.StorageFeesCost,replacementValuation:this.ValuationCost,otherServices:JSON.stringify(_.map(this.OtherServices,function(n){return{Description:n.Description,QuoteID:n.QuoteID,ServiceID:n.ServiceID,Type:n.Type,Price:n.Price}})),employees:JSON.stringify(_.map(this.Employee_Rels,function(n){return{EmployeeID:n.EmployeeID,Bonus:n.Bonus,Commission:n.Commission,Hours:n.Hours,IsRemoved:n.IsRemoved,Tip:n.Tip,Wage:n.Wage,IsDriver:n.IsDriver}})),vehicles:JSON.stringify(_.map(this.Vehicle_Rels,function(n){return{VehicleID:n.VehicleID,IsRemoved:n.IsRemoved}}))}},u.prototype.cancel=function(){return this.IsCancelled=this.hasChanged=!0},u.prototype.sync=function(n){var t,i;if(this.IsComplete){this.hasChanged=!1;return}return this.hasChanged?(i=SERVER.baseUrl+"PostingPage/SaveHourlyPostData/"+this.PostingID,this.IsHourly||(i=SERVER.baseUrl+"PostingPage/SaveGuaranteedPostData/"+this.PostingID),t=this,t.hasChanged=!1,$.postq("posting",i,this.toServerObject(),function(i){return $.isFunction(n)&&n(i),_.each(i,function(n,i){var r;return r=_.find(t.OtherServices,function(n){return n.ServiceID===i}),r&&(r.ServiceID=n),t.container.find("input[name=serviceid][value="+i+"]").val(n),t.container.find("input[data-field="+i+"]").data("field",n)})})):n()},u}(),window.Posting=u}).call(this)